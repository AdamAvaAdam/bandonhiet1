<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ƒêi·ªÅu ph·ªëi V10.4 - D≈©ng Nguy·ªÖn</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; background: #1e272e; overflow: hidden; }
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1e272e; display: flex; align-items: center; justify-content: center; z-index: 10000; }
        .login-box { background: #2d3436; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.7); width: 85%; max-width: 320px; text-align: center; border: 2px solid #ff4757; }
        .login-box h2 { color: #ff4757; margin-bottom: 20px; }
        .login-box input { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #485460; background: #1e272e; color: white; font-size: 16px; box-sizing: border-box; }
        .login-box button { width: 100%; padding: 14px; background: #ff4757; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        #main-app { display: none; height: 100vh; flex-direction: column; }
        #map { flex-grow: 1; width: 100%; }
        #sidebar { width: 100%; max-height: 50%; background: #1e272e; color: #ecf0f1; overflow-y: auto; z-index: 1000; padding: 12px; box-sizing: border-box; border-top: 2px solid #ff4757; }
        
        @media (min-width: 768px) {
            #main-app { flex-direction: row; }
            #sidebar { width: 420px; max-height: 100%; border-top: none; border-right: 2px solid #ff4757; }
        }

        .card { background: #2d3436; border-radius: 10px; padding: 10px; margin-bottom: 10px; border: 1px solid #485460; }
        .card-title { font-weight: bold; color: #ff4757; margin-bottom: 6px; font-size: 12px; border-bottom: 1px solid #485460; padding-bottom: 4px; text-transform: uppercase; }
        
        input, select, button.action-btn { width: 100%; padding: 8px; margin-top: 5px; border-radius: 6px; border: none; font-size: 14px; box-sizing: border-box; }
        .btn-refresh { background: #2ecc71; color: white; font-weight: bold; margin-bottom: 5px; }
        .btn-search { background: #3498db; color: white; font-weight: bold; }
        .btn-clear { background: #7f8c8d; color: white; font-weight: bold; margin-top: 5px; }

        #zoom-info { position: absolute; top: 10px; right: 10px; z-index: 1000; background: rgba(0,0,0,0.8); color: #f1c40f; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; border: 1px solid #ff4757; }
        .stats-box { background: #34495e; padding: 10px; border-radius: 8px; margin-top: 8px; border-left: 4px solid #ff4757; }
        .dealer-list { display: none; margin-top: 8px; border-top: 1px solid #555; padding-top: 8px; }
        .dealer-row { display: grid; grid-template-columns: 1fr 75px 55px; gap: 4px; padding: 4px 0; border-bottom: 1px solid #444; font-size: 11px; align-items: center; }
        .sales-tag { color: #f1c40f; text-align: right; font-weight: bold; }
        
        .leaflet-heatmap-layer { pointer-events: none !important; opacity: 0.9 !important; }
        .leaflet-marker-pane { z-index: 650 !important; }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <h2>H·ªÜ TH·ªêNG V10.4</h2>
        <input type="text" id="username" placeholder="T√™n ƒëƒÉng nh·∫≠p">
        <input type="password" id="password" placeholder="M·∫≠t kh·∫©u">
        <button onclick="checkLogin()">ƒêƒÇNG NH·∫¨P</button>
        <p id="login-error" style="color: #ff4757; font-size: 12px; margin-top: 10px; display: none;">Sai th√¥ng tin!</p>
    </div>
</div>

<div id="main-app">
    <div id="map"></div>
    <div id="zoom-info">Z: <span id="zoom-level">12</span></div>
    
    <div id="sidebar">
        <div class="card">
            <div class="card-title">üîç T√åM KHU V·ª∞C</div>
            <input type="text" id="areaSearchInput" placeholder="Vd: Ninh B√¨nh">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <button class="action-btn btn-search" onclick="searchArea()">XEM VI·ªÄN</button>
                <button class="action-btn btn-clear" onclick="clearHighlight()">X√ìA VI·ªÄN</button>
            </div>
        </div>
        
        <div class="card">
            <div class="card-title">üìç THI·∫æT L·∫¨P KHO & B√ÅN K√çNH</div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: center;">
                <select id="pinToggle"><option value="off">XEM</option><option value="on">C·∫ÆM KHO</option></select>
                <div style="position: relative;">
                    <input type="number" id="radiusInput" value="3" step="0.5" min="0.1" oninput="updateAllRadius()" style="padding-right: 30px;">
                    <span style="position: absolute; right: 8px; top: 13px; color: #2d3436; font-size: 11px; font-weight: bold;">KM</span>
                </div>
            </div>
        </div>

        <div id="warehouse-list"></div>

        <div class="card">
            <div class="card-title">üîÑ D·ªÆ LI·ªÜU & HI·ªÇN TH·ªä</div>
            <button class="action-btn btn-refresh" onclick="loadDataOnline()">L√ÄM M·ªöI T·ª™ SHEETS</button>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <select id="pointToggle" onchange="togglePointLayer()"><option value="on">ƒêI·ªÇM: B·∫¨T</option><option value="off">ƒêI·ªÇM: T·∫ÆT</option></select>
                <select id="heatToggle" onchange="toggleHeatLayer()"><option value="on">NHI·ªÜT: B·∫¨T</option><option value="off">NHI·ªÜT: T·∫ÆT</option></select>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

<script>
    function checkLogin() {
        if (document.getElementById('username').value === 'admin' && document.getElementById('password').value === '123456') {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
            map.invalidateSize(); loadDataOnline();
        } else { document.getElementById('login-error').style.display = 'block'; }
    }

    const map = L.map('map', { tap: true, zoomSnap: 0.1, zoomControl: false }).setView([21.02, 105.83], 12);
    L.control.zoom({ position: 'topleft' }).addTo(map);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);

    let dealers = [], warehouses = [], highlightLayer = L.layerGroup().addTo(map), 
        heatLayerGroup = L.layerGroup().addTo(map), dealerLayer = L.layerGroup().addTo(map), heatLayer = null;

    async function loadDataOnline() {
        const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSqx48yei68qBJFSiHZzxCeGO0df4IDE6md9hzu7TUv5GjgOvU9yIpm4lEN6HJw9zJuek4YYMj8XAyn/pub?gid=0&single=true&output=csv";
        try {
            const r = await fetch(url);
            const t = await r.text();
            const rows = t.split(/\r?\n/).slice(1);
            dealers = []; dealerLayer.clearLayers();
            let hp = [];
            rows.forEach(line => {
                const col = line.split(/,|\t/);
                if (col.length < 6) return;
                let ds = parseFloat(col[5].toString().replace(/\./g, '').replace(/,/g, '')) || 0;
                let lat = parseFloat(col[4].toString().replace(',', '.'));
                let lng = parseFloat(col[3].toString().replace(',', '.'));
                if (!isNaN(lat) && !isNaN(lng)) {
                    const m = L.circleMarker([lat, lng], { radius: 5, color: '#2d3436', weight: 1, fillOpacity: 0.8, fillColor: ds > 0 ? '#ff4757' : '#95a5a6', interactive: true });
                    m.bindTooltip(`<b>${col[1]}</b><br>DS: ${ds.toLocaleString()}`, { sticky: true });
                    dealers.push({ latlng: L.latLng(lat, lng), ds, ten: col[1], marker: m });
                    if (document.getElementById('pointToggle').value === 'on') m.addTo(dealerLayer);
                    // C·∫¨P NH·∫¨T C∆Ø·ªúNG ƒê·ªò G·∫ÆT H∆†N
                    if (ds > 0) {
                        let intensity = 0.5 + (ds / 300000000) * 0.5; // ƒê·∫°t ƒë·ªânh ƒë·ªè nhanh h∆°n
                        hp.push([lat, lng, Math.min(intensity, 1.5)]);
                    }
                }
            });
            if (heatLayer) heatLayerGroup.removeLayer(heatLayer);
            // THI·∫æT L·∫¨P GRADIENT SI√äU T∆Ø∆†NG PH·∫¢N
            heatLayer = L.heatLayer(hp, { 
                radius: 80, 
                blur: 18, // Gi·∫£m blur ƒë·ªÉ m√†u s·∫Øc c√¥ ƒë·ªçng, kh√¥ng b·ªã m·ªù
                max: 1.0, 
                gradient: { 
                    0.2: '#ffd32a', // V√†ng chanh s√°ng
                    0.4: '#ff3f34', // ƒê·ªè cam r·ª±c
                    0.7: '#b71540', // ƒê·ªè th·∫´m
                    1.0: '#3e0e0e'  // ƒê·ªè ƒëen (ƒê·∫∑c qu√°nh)
                } 
            });
            if (document.getElementById('heatToggle').value === 'on') heatLayer.addTo(heatLayerGroup);
        } catch (e) { alert("L·ªói t·∫£i!"); }
    }

    async function searchArea() {
        const input = document.getElementById('areaSearchInput').value;
        if (!input) return;
        const resp = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(input + ", Vietnam")}&format=json&polygon_geojson=1&limit=1`);
        const data = await resp.json();
        if (data.length > 0) {
            highlightLayer.clearLayers();
            const g = L.geoJSON(data[0].geojson, { style: { color: "#3498db", weight: 3, fillOpacity: 0 }, interactive: false }).addTo(highlightLayer);
            map.fitBounds(g.getBounds(), { padding: [20, 20] });
        }
    }
    function clearHighlight() { highlightLayer.clearLayers(); }

    function togglePointLayer() {
        dealerLayer.clearLayers();
        if (document.getElementById('pointToggle').value === 'on') dealers.forEach(d => d.marker.addTo(dealerLayer));
    }
    function toggleHeatLayer() {
        if (!heatLayer) return;
        document.getElementById('heatToggle').value === 'on' ? heatLayer.addTo(heatLayerGroup) : heatLayerGroup.removeLayer(heatLayer);
    }

    map.on('zoomend', () => {
        const z = map.getZoom(); document.getElementById('zoom-level').innerText = z.toFixed(1);
        if (heatLayer) {
            // T·ªëi ∆∞u b√°n k√≠nh cho c√°c m·ªëc zoom quan tr·ªçng
            let r = (z >= 14) ? 90 : (z >= 12.5 ? 75 : 55);
            heatLayer.setOptions({ radius: r, blur: (z >= 13 ? 25 : 18) });
        }
    });

    map.on('click', e => {
        if (document.getElementById('pinToggle').value !== 'on') return;
        const radiusKm = parseFloat(document.getElementById('radiusInput').value) || 3;
        const m = L.marker(e.latlng, { draggable: true }).addTo(map);
        const c = L.circle(e.latlng, { radius: radiusKm * 1000, color: '#ff4757', fillOpacity: 0.1, interactive: false }).addTo(map);
        const id = Date.now();
        const wh = { id, marker: m, circle: c, latlng: e.latlng, radius: radiusKm * 1000, name: "Kho " + (warehouses.length + 1) };
        m.on('contextmenu', () => deleteWh(id));
        m.on('dragend', () => { wh.latlng = m.getLatLng(); c.setLatLng(wh.latlng); updateStats(); });
        warehouses.push(wh); updateStats();
    } );

    function updateAllRadius() {
        const rKm = parseFloat(document.getElementById('radiusInput').value) || 3;
        warehouses.forEach(w => { w.radius = rKm * 1000; w.circle.setRadius(rKm * 1000); });
        updateStats();
    }

    async function getRouteDistance(start, end) {
        try {
            const url = `https://router.project-osrm.org/route/v1/driving/${start.lng},${start.lat};${end.lng},${end.lat}?overview=false`;
            const r = await fetch(url); const d = await r.json();
            return d.code === 'Ok' ? (d.routes[0].distance / 1000).toFixed(1) + "k" : "N/A";
        } catch (e) { return "Err"; }
    }

    async function toggleList(id) {
        const listDiv = document.getElementById(`list-${id}`);
        listDiv.style.display = (listDiv.style.display === "block") ? "none" : "block";
        if (listDiv.style.display === "block") {
            const wh = warehouses.find(w => w.id === id);
            const items = listDiv.querySelectorAll('.dist-val');
            for (let item of items) {
                if (item.innerText === "...") item.innerText = await getRouteDistance(wh.latlng, {lat: item.dataset.lat, lng: item.dataset.lng});
            }
        }
    }

    function deleteWh(id) {
        const wh = warehouses.find(w => w.id === id);
        if (wh) { map.removeLayer(wh.marker); map.removeLayer(wh.circle); warehouses = warehouses.filter(w => w.id !== id); updateStats(); }
    }

    function updateStats() {
        const d = document.getElementById('warehouse-list');
        d.innerHTML = '<strong style="color:#ff4757; display:block; margin:5px 0; font-size:12px;">DANH S√ÅCH KHO:</strong>';
        warehouses.forEach(w => {
            const inR = dealers.filter(x => w.latlng.distanceTo(x.latlng) <= w.radius);
            const sum = inR.reduce((a, b) => a + b.ds, 0);
            const rows = inR.sort((a,b) => b.ds - a.ds).map(x => `
                <div class="dealer-row">
                    <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${x.ten}</span>
                    <span class="sales-tag">${x.ds.toLocaleString()}</span>
                    <span class="dist-tag dist-val" data-lat="${x.latlng.lat}" data-lng="${x.latlng.lng}">...</span>
                </div>`).join('');
            d.innerHTML += `
                <div class="stats-box">
                    <div onclick="toggleList(${w.id})" style="cursor:pointer; font-weight:bold; display:flex; justify-content:space-between; font-size:13px;">
                        ${w.name} (${(w.radius/1000).toFixed(1)}km) <span>‚ñº</span>
                    </div>
                    <div style="font-size:11px; margin-top:3px; color:#bdc3c7;">KH: ${inR.length} | T·ªïng DS: <b style="color:#f1c40f">${sum.toLocaleString()}</b></div>
                    <div class="dealer-list" id="list-${w.id}">
                        ${rows || '<div style="padding:5px;">Tr·ªëng</div>'}
                        <button style="background:#ff4757; color:white; padding:5px; margin-top:8px; width:100%; border:none; border-radius:4px; font-weight:bold;" onclick="deleteWh(${w.id})">X√ìA</button>
                    </div>
                </div>`;
        });
    }
</script>
</body>
</html>
